<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
 <head>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <title>Однократные подмаски</title>

 </head>
 <body><div class="manualnavbar" style="text-align: center;">
 <div class="prev" style="text-align: left; float: left;"><a href="regexp.reference.assertions.html">Утверждения</a></div>
 <div class="next" style="text-align: right; float: right;"><a href="regexp.reference.conditional.html">Условные подмаски</a></div>
 <div class="up"><a href="reference.pcre.pattern.syntax.html">Описание синтаксиса Perl-совместимых регулярных выражений</a></div>
 <div class="home"><a href="index.html">PHP Manual</a></div>
</div><hr /><div id="regexp.reference.onlyonce" class="section">
  <h2 class="title">Однократные подмаски</h2>
  <p class="para">
   Как для минимального, так и максимального количества повторений,
   если последующая часть шаблона терпит неудачу при сопоставлении,
   происходит повторный анализ повторяемого выражения на предмет того,
   возможно ли успешное сопоставление всего шаблона при другом количестве
   повторений. Бывают случаи, когда необходимо изменить описанную логику
   работы для реализации специфического сопоставления либо оптимизации шаблона
   (если автор уверен, что других вариантов соответствия нет).
  </p>
  <p class="para">
   В качестве примера, рассмотрим шаблон \d+foo  в применении к строке

   <em>123456bar</em>
  </p>
  <p class="para">
   После того, как \d+ будет сопоставлен с первыми шестью цифрами,
   сопоставление &quot;foo&quot; потерпит неудачу. После этого, в соответствие
   \d+, будет сопоставлено 5 цифр, после очередной неудачи будет сопоставлено
   4 цифры и так далее. В конце концов весь шаблон потерпит неудачу.
   Однократные подмаски указывают, что если одна часть шаблона была
   сопоставлена, ее не стоит анализировать повторно. Применимо к приведенному
   выше примеру весь шаблон потерпел бы неудачу после первого же
   неудачного сопоставления с &quot;foo&quot;. Записываются однократные шаблоны
   при помощи круглых скобок следующим образом: (?&gt;. Например:

   <em>(?&gt;\d+)bar</em>
  </p>
  <p class="para">
   Этот вид подмаски предотвращает повторный ее анализ в случае, если
   сопоставление последующих элементов терпят неудачу. Однако, это не мешает
   повторно анализировать любые другие элементы, в том числе предшествующие
   однократной подмаске.
  </p>
  <p class="para">
   Говоря другими словами, подмаски такого типа соответствуют
   той части подстроки, которой соответствовала бы одиночная
   изолированная маска, заякоренная на текущей позиции обрабатываемого
   текста.
  </p>
  <p class="para">
   Однократные подмаски являются незахватывающими. Простые примеры,
   подобные приведенному выше, можно охарактеризовать как безусловный
   захват максимального количества повторений. В то время как
   \d+ и \d+? корректируются так, чтобы остальные части шаблона
   так же совпали, (?&gt;\d+) соответствует исключительно максимальной по
   длине последовательности цифр, даже если это приводит к неудаче при
   сопоставлении других частей шаблона.
  </p>
  <p class="para">
   Однократные подмаски могут включать в себя более сложные конструкции,
   а также могут быть вложенными.
  </p>
  <p class="para">
   Однократные подмаски могут использоваться совместно с утверждениями
   касательно предшествующего текста для описания эффективных сопоставлений
   в конце обрабатываемого текста. Рассмотрим простой шаблон

   <em>abcd$</em>

   в применении к длинному тексту, который не соответствует указанной маске.
   Поскольку поиск происходит слева направо, вначале PCRE будет
   искать букву &quot;a&quot;, и только потом анализировать следующие
   записи в шаблоне. В случае, если шаблон указан в виде

   <em>^.*abcd$</em>.

   В таком случае вначале .* сопоставляется со всей строкой, после
   чего сопоставление терпит неудачу (так как нет последующего символа &#039;a&#039;).
   После чего .* сопоставляется со всей строкой, кроме последнего символа,
   потом кроме двух последних символов, и так далее. В конечном итоге
   поиск символа &#039;a&#039; происходит по всей строке. Однако, если шаблон записать
   в виде:

   <em>^(?&gt;.*)(?&lt;=abcd)</em>

   повторный анализ для .* не выполняется, и, как следствие, может
   соответствовать только всей строке целиком. После чего утверждение
   проверяет последние четыре символа на совпадение с &#039;abcd&#039;, и в случае
   неудачи все сопоставление терпит неудачу. Для больших объемов
   обрабатываемого текста этот подход имеет значительный выигрыш во времени
   выполнения.
  </p>
  <p class="para">
   Если шаблон содержит неограниченное повторение внутри подмаски,
   которая в свою очередь также может повторяться неограниченное количество
   раз, использование однократных  подмасок позволяет
   избегать многократных неудачных сопоставлений,
   которые длятся достаточно продолжительное время. Шаблон

   <em>(\D+|&lt;\d+&gt;)*[!?]</em>

   соответствует неограниченному количеству подстрок, которые состоят
   не из цифр,  либо из цифр заключенных в &lt;&gt;, за которыми следует
   ? либо !. В случае, если в обрабатываемом тексте содержатся
   соответствия, время работы регулярного выражения будет невелико.
   Но если его применить к строке

   <em>aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa</em>

   это займет длительное время. Это связанно с тем, что строка
   может быть разделена между двумя частями шаблона многими способами,
   и все они будут опробованы (в примере мы использовали [?!], поскольку
   в случае одиночного символа в конце шаблона и PCRE и Perl выполняют
   оптимизацию. Они запоминают последний одиночный символ и в случае
   его отсутствия выдают неудачу).  Если изменить шаблон на

   <em>((?&gt;\D+)|&lt;\d+&gt;)*[!?]</em>,

   нецифровые последовательности не могут быть разорваны, и
   невозможность сопоставления обнаруживается гораздо быстрее.
  </p>
 </div><hr /><div class="manualnavbar" style="text-align: center;">
 <div class="prev" style="text-align: left; float: left;"><a href="regexp.reference.assertions.html">Утверждения</a></div>
 <div class="next" style="text-align: right; float: right;"><a href="regexp.reference.conditional.html">Условные подмаски</a></div>
 <div class="up"><a href="reference.pcre.pattern.syntax.html">Описание синтаксиса Perl-совместимых регулярных выражений</a></div>
 <div class="home"><a href="index.html">PHP Manual</a></div>
</div></body></html>
